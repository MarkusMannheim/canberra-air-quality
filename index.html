
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Canberra's air quality</title>
    <meta name="description" content="Real-time visualisation of the ACT's pollution levels (PM 2.5 particles).">
    <meta name="keywords" content="canberra, act, air, quality, aqi, pollution, pm25, smoke, bushfires">
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Initial scripts -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <link href="./resources/style.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
    <!-- Page data for scrapers -->
    <meta property="og:title" content="Canberra's air quality">
    <meta property="og:description" content="Real-time visualisation of the ACT's pollution levels (PM 2.5 particles).">
    <meta property="og:image" content="https://markusmannheim.github.io/canberra-air-quality/resources/bushfireMap.jpg">
    <meta property="og:url" content="https://markusmannheim.github.io/canberra-air-quality/">
    <meta property="og:type" content="website">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="@MarkusMannheim">
    <meta property="twitter:creator" content="@MarkusMannheim">
  </head>
  <body>
    <!-- Initial page layout -->
    <svg id="chart">
      <g id="chartGroup">
        <g id="hazardLine">
          <line y1="0" y2="0"></line>
          <text y="-5">hazardous levels</text>
        </g>
      </g>
      <g id="axisGroup">
        <g id="xAxisGroup"></g>
        <g id="yAxisGroup"></g>
      </g>
    </svg>
    <div id="description"></div>
    <div id="selector">
      <div class="option" value="28">MONTH</div>
      <div class="option" value="7">WEEK</div>
      <div class="option selected" value="1">DAY</div>
    </div>
    <div id="siteSelector">
      <div class="option" value="Florey">NORTH</div>
      <div class="option" value="Civic">CENTRAL</div>
      <div class="option selected" value="Monash">SOUTH</div>
    </div>
    <script>
      // load data
      d3.json("https://www.data.act.gov.au/resource/94a5-zqnn.json?$query=SELECT name,datetime,aqi_pm2_5 ORDER BY datetime DESC LIMIT 2016", function(error, data) {
        if (error) throw error;
        airData = data
          .filter(function(d) {
            return d.datetime && d.aqi_pm2_5;
          })
          .map(function(d) {
            d.datetime = new Date(d.datetime);
            d.aqi_pm2_5 = +d.aqi_pm2_5;
            return d;
          });
        // page elements
        margin = { top: 40, right: 15, bottom: 60, left: 40 };
        sites = [
          ["Monash", "south Canberra"],
          ["Florey", "north Canberra"],
          ["Civic", "central Canberra"]
        ];
        base = d3.select("#base");
        chart = d3.select("#chart");
        chartGroup = d3.select("#chartGroup");
        xAxisGroup = d3.select("#xAxisGroup");
        yAxisGroup = d3.select("#yAxisGroup")
          .attr("transform", "translate(" + margin.left + ", 0)");
        options = d3.selectAll(".option")
          .on("click", changeSelector);
        selection = 1;
        lastDate = data[0].datetime;
        // set up scales, axes
        x = d3.scaleTime();
        xAxis = d3.axisBottom(x)
          .tickSizeOuter(0)
          .ticks(5);
        y = d3.scaleLinear();
        yAxis = d3.axisLeft(y)
          .tickSizeOuter(0)
          .ticks(5);
        line = d3.line()
          .x(function(d) { return x(d.datetime);})
          .y(function(d) { return y(d.aqi_pm2_5); })
          .curve(d3.curveCardinalOpen);
        hazardLine = d3.select("#hazardLine");
        hazardLine.select("line")
          .attr("x1", margin.left);
        sites = chartGroup
          .selectAll(".site")
            .data(sites, function(d) { return d[1]; })
          .enter().append("path")
            .attr("id", function(d) { return d[0]; })
            .classed("site", true);
        // window resize event
        window.addEventListener("resize", resize);
        resize();
        // initial fade-in and zoom
        d3.select("body").transition()
          .duration(2000)
          .style("opacity", 1);
      });
      // re-plot when window resizes
      function resize() {
        let dimensions = document.getElementById("chart").getBoundingClientRect();
        chartWidth = dimensions.width;
        chartHeight = dimensions.height;
        xAxisGroup.attr("transform", "translate(0, " + (chartHeight - margin.bottom) + ")");
        x.range([margin.left, chartWidth - margin.right]);
        y.range([chartHeight - margin.bottom, margin.top]);
        hazardLine.select("line")
          .attr("x2", chartWidth - margin.right);
        hazardLine.select("text")
          .attr("x", chartWidth - margin.right);
        recalculate();
      }
      // click/touch selector
      function changeSelector() {
        options.classed("selected", false);
        selection = +d3.select(this).attr("value");
        d3.select(this).classed("selected", true);
        recalculate();
      }
      // calculate scales & axes
      function recalculate() {
        firstDate = new Date(new Date(lastDate).setDate(lastDate.getDate() - selection));
        activeData = airData
          .filter(function(d) { return d.datetime >= firstDate; });
        x.domain(d3.extent(activeData, function(d) { return d.datetime; }));
        y.domain([0, d3.max(activeData, function(d) { return d.aqi_pm2_5; })]);
        draw();
      }
      // draw axes & pollution lines
      function draw() {
        xAxisGroup.transition()
          .duration(2000)
          .call(xAxis);
        yAxisGroup.transition()
          .duration(2000)
          .call(yAxis);
        sites.transition()
          .duration(2000)
          .attr("d", function(d) { return line(activeData.filter(function(e) { return d[0] == e.name; })); });
        hazardLine.transition()
          .duration(2000)
          .attr("transform", "translate(0, " + y(200) + ")");
      }
    </script>
  </body>
</html>
