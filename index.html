
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Canberra's air quality</title>
    <meta name="description" content="Real-time visualisation of fine particulate pollution (PM2.5).">
    <meta name="keywords" content="canberra, act, air, quality, aqi, pollution, pm25, smoke, bushfires">
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Initial scripts -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <link href="./resources/style.css?v1.5" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
    <!-- Page data for scrapers -->
    <meta property="og:title" content="Canberra's air quality">
    <meta property="og:description" content="Real-time visualisation of fine particulate pollution (PM2.5).">
    <meta property="og:image" content="https://markusmannheim.github.io/canberra-air-quality/resources/parlySmoke.jpg">
    <meta property="og:url" content="https://markusmannheim.github.io/canberra-air-quality/">
    <meta property="og:type" content="website">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="@MarkusMannheim">
    <meta property="twitter:creator" content="@MarkusMannheim">
  </head>
  <body>
    <!-- Initial page layout -->
    <svg id="chart">
      <defs>
        <clipPath id="chartClip">
          <rect></rect>
        </clipPath>
      </defs>
      <g id="chartGroup">
        <g id="hazardGroup"></g>
      </g>
      <g id="axisGroup">
        <g id="xAxisGroup"></g>
        <g id="yAxisGroup">
          <text id="axisLabel">PM2.5 μg/m³</text>
        </g>
      </g>
    </svg>
    <div id="description"></div>
    <div id="selector">
      <div class="option" value="28">MONTH</div>
      <div class="option" value="7">WEEK</div>
      <div class="option selected" value="1">DAY</div>
    </div>
    <div id="siteSelector">
      <div class="option all" value="Florey">NORTH</div>
      <div class="option all" value="Civic">CENTRAL</div>
      <div class="option all" value="Monash">SOUTH</div>
    </div>
    <div id="tip"></div>
    <div id="info" class="selected" onclick="infoSwitch()">&#9432;</div>
    <div id="infoPanel" onclick="infoSwitch()">
      <p>This charts hourly air-quality data from the <a href='https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-7' target='_blank'>ACT Government's three monitoring stations</a>. It measures fine particles (PM2.5) in the air, which are the most harmful to health. The Government also provides <a href='https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-0#air-quality-table' target='_blank'>health advice about PM2.5 levels</a>.</p>
    </div>
    <script>
      // load data
      d3.json("https://www.data.act.gov.au/resource/ufvu-jybu.json?$query=SELECT station,datetime,pm2_5_1_hr ORDER BY datetime DESC LIMIT 2016", function(error, data) {
        if (error) throw error;
        backupData = data;
        airData = data
          .filter(function(d) {
            return d.datetime && d.pm2_5_1_hr;
          })
          .map(function(d) {
            d.datetime = d3.timeParse("%Y-%m-%dT%H:%M:%S.%L")(d.datetime);
            d.pm2_5_1_hr = +d.pm2_5_1_hr;
            return d;
          });
        // page elements
        margin = { top: 40, right: 20, bottom: 60, left: 40 };
        siteData = [
          ["Monash", "south Canberra"],
          ["Florey", "north Canberra"],
          ["Civic", "central Canberra"]
        ];
        base = d3.select("#base");
        chart = d3.select("#chart");
        info = d3.select("#info");
        infoPanel = d3.select("#infoPanel");
        infoToggle = false;
        chartGroup = d3.select("#chartGroup");
        chartClip = d3.select("#chartClip");
        chartClip.select("rect")
          .attr("x", margin.left)
          .attr("y", margin.top - 5);
        tip = d3.select("#tip");
        xAxisGroup = d3.select("#xAxisGroup");
        yAxisGroup = d3.select("#yAxisGroup")
          .attr("transform", "translate(" + margin.left + ", 0)");
        axisLabel = d3.select("#axisLabel")
          .attr("y", margin.top - 15)
          .style("font-size", ".8rem");
        options = d3.selectAll("#selector .option")
          .on("click", changeSelector);
        siteOptions = d3.selectAll("#siteSelector .option")
          .on("click", changeSite);
        selectedPeriod = 1;
        selectedSite = "all";
        lastDate = data[0].datetime;
        // set up hazard lines
        hazardData = [
          ["hazardous", 177.9],
          ["very unhealthy", 107],
          ["unhealthy for all", 40]
        ];
        hazardGroup = d3.select("#hazardGroup");
        hazards = hazardGroup
          .selectAll(".hazard")
            .data(hazardData)
          .enter().append("g")
            .classed("hazard", true)
            .attr("id", function(d) { return d[0]; });
        hazards.append("line")
          .attr("x1", margin.left);
        hazards.append("text")
          .text(function(d) { return d[0]; })
          .attr("y", -5);
        // set up scales, axes, voronoi
        x = d3.scaleTime();
        xAxis = d3.axisBottom(x)
          .tickSizeOuter(0)
          .ticks(5);
        y = d3.scaleLinear();
        yAxis = d3.axisLeft(y)
          .tickSizeOuter(0)
          .ticks(5);
        // set up pollution lines
        line = d3.line()
          .x(function(d) { return x(d.datetime); })
          .y(function(d) { return y(d.pm2_5_1_hr); })
          .curve(d3.curveCardinal);
        sites = chartGroup
          .selectAll(".site")
            .data(siteData, function(d) { return d[1]; })
          .enter().append("path")
            .attr("id", function(d) { return d[0]; })
            .classed("site", true)
            .classed("selected", true);
        // set up voronoi cells
        voronoi = d3.voronoi()
          .x(function(d) { return x(d.datetime); })
          .y(function(d) { return y(d.pm2_5_1_hr); });
        // window resize event
        window.addEventListener("resize", resize);
        resize();
        // initial fade-in and zoom
        d3.select("body").transition()
          .duration(1500)
          .style("opacity", 1);
      });
      // re-plot when window resizes
      function resize() {
        let dimensions = document.getElementById("chart").getBoundingClientRect();
        chartWidth = dimensions.width;
        chartHeight = dimensions.height;
        xAxisGroup.attr("transform", "translate(0, " + (chartHeight - margin.bottom) + ")");
        x.range([margin.left, chartWidth - margin.right]);
        y.range([chartHeight - margin.bottom, margin.top]);
        hazards.select("line")
          .attr("x2", chartWidth - margin.right);
        hazards.select("text")
          .attr("x", chartWidth - margin.right);
        chartClip.select("rect")
          .attr("width", chartWidth - margin.left - margin.right)
          .attr("height", chartHeight - margin.top - margin.bottom + 5);
        voronoi.size([chartWidth, chartHeight]);
        recalculate();
      }
      // click/touch selector
      function changeSelector() {
        options.classed("selected", false);
        selectedPeriod = +d3.select(this).attr("value");
        d3.select(this).classed("selected", true);
        recalculate();
      }
      // calculate scales & axes
      function recalculate() {
        firstDate = new Date(new Date(lastDate).setDate(lastDate.getDate() - selectedPeriod));
        activeData = airData
          .filter(function(d) {
            return d.station == selectedSite || selectedSite == "all";
          });
        x.domain(d3.extent(activeData.filter(function(d) { return d.datetime >= firstDate; }), function(d) { return d.datetime; }));
        y.domain([0, d3.max(activeData.filter(function(d) { return d.datetime >= firstDate; }), function(d) { return d.pm2_5_1_hr; })]).nice();
        draw();
      }
      // draw axes & pollution lines
      function draw() {
        xAxisGroup.transition()
          .duration(1500)
          .call(xAxis);
        yAxisGroup.transition()
          .duration(1500)
          .call(yAxis);
        sites.transition()
          .duration(1500)
          .attr("d", function(d) { return line(airData.filter(function(e) { return d[0] == e.station; })); });
        hazards.transition()
          .duration(1500)
          .attr("transform", function(d) { return "translate(0, " + y(d[1]) + ")"; });
        hazards.selectAll("text, line")
          .transition()
            .duration(1500)
            .style("opacity", function(d, i) {
              return d[0] == "hazardous" ? 1 :
                d[0] == "very unhealthy" ? (y(hazardData[1][1]) - y(hazardData[0][1]) < 20 ? 0 : 1) :
                y(hazardData[2][1]) - y(hazardData[1][1]) < 20 ? 0 : 1;
            });
        cells = chartGroup
          .selectAll(".cell")
            .data(voronoi.polygons(activeData.filter(function(d) { return d.datetime >= firstDate; })), function(d) { return d; });
        entering = cells
          .enter().append("g")
            .classed("cell", true)
            .on("mouseover", reveal)
            .on("mouseout", hide);
        entering.append("path")
          .attr("d", function(d) { return !d ? null : d3.line()(d) + "Z"; });
        entering.append("circle")
          .attr("cx", function(d) { return !d ? null : x(d.data.datetime); })
          .attr("cy", function(d) { return !d ? null : y(d.data.pm2_5_1_hr); })
          .attr("class", function(d) { return !d ? null : d.data.station; });
        cells.exit()
          .remove();
        cells.select("path")
          .attr("d", function(d) { return !d ? null : d3.line()(d) + "Z"; });
        cells.select("circle")
          .attr("cx", function(d) { return !d ? null : x(d.data.datetime); })
          .attr("cy", function(d) { return !d ? null : y(d.data.pm2_5_1_hr); });
        d3.selectAll(".cell")
          .style("pointer-events", "none")
          .transition()
            .delay(1500)
            .style("pointer-events", "auto");
      }
      // reveal & hide readings
      function hide(d) {
        d3.select(this)
          .select("circle")
          .classed("selected", false);
        tip.style("opacity", 0);
      }
      function reveal(d) {
        d3.select(this)
          .select("circle")
          .classed("selected", true);
        tip.style("opacity", 0)
          .attr("class", d.data.station)
          .style("top", "0px")
          .style("left", "0px")
          .html("<h1>" + d3.format(".1f")(d.data.pm2_5_1_hr) + "</h1>"
              + "<p>" + d.data.station + ", " + d3.timeFormat("%-I%p, %b %-d")(d.data.datetime) + "</p>");
        let tipWidth = parseFloat(tip.style("width"));
        let tipHeight = parseFloat(tip.style("height"));
        tip.style("top", function() {
            return y(d.data.pm2_5_1_hr) + 10 + tipHeight < chartHeight - margin.bottom ?
              (y(d.data.pm2_5_1_hr) + 10) + "px" :
              (y(d.data.pm2_5_1_hr) - 10 - tipHeight) + "px";
          })
          .style("left", function() {
            return x(d.data.datetime) + 10 + tipWidth < chartWidth - margin.right ?
              (x(d.data.datetime) + 10) + "px" :
              (x(d.data.datetime) - 10 - tipWidth) + "px";
          })
          .style("opacity", 1);
      }
      // change site selection
      function changeSite() {
        console.log(d3.select(this).attr("value") + " " + selectedSite);
        if (selectedSite !== "all" && selectedSite == d3.select(this).attr("value")) {
          selectedSite = "all";
          siteOptions.classed("selected", false);
          sites.classed("selected", true);
          siteOptions.classed("all", true);
        } else {
          selectedSite = d3.select(this)
            .attr("value");
          siteOptions.classed("all", false);
          siteOptions.classed("selected", false);
          sites.classed("selected", false);
          d3.select(this).classed("selected", true);
          sites.filter(function(d) { return d[0] == selectedSite; })
            .classed("selected", true)
            .raise();
        }
        recalculate();
      }
      // info panel
      function infoSwitch() {
        infoToggle = !infoToggle;
        infoPanel.classed("selected", infoToggle);
        info.classed("selected", !infoToggle);
      }
    </script>
  </body>
</html>
